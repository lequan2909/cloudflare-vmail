---
import { ClientRouter } from 'astro:transitions'
import '../globals.css'
import { Dock } from '../components/Dock'

interface Props {
  title: string
  description: string
}

const { title, description } = Astro.props
const Env = Astro.locals.runtime.env
---

<script is:inline>
  function applyTheme() {
    function getThemePreference() {
      if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
        return localStorage.getItem('theme')
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
    }
    const isDark = getThemePreference() === 'dark'
    document.documentElement.classList[isDark ? 'add' : 'remove']('dark')
  }

  // Apply theme immediately on page load
  applyTheme()

  // Apply theme before swap to prevent flash
  document.addEventListener('astro:before-swap', (event) => {
    // Apply theme to the new document before it's swapped
    const newDocument = event.newDocument
    function getThemePreference() {
      if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
        return localStorage.getItem('theme')
      }
      return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light'
    }
    const isDark = getThemePreference() === 'dark'
    newDocument.documentElement.classList[isDark ? 'add' : 'remove']('dark')
  })

  // Ensure theme is applied after page load
  document.addEventListener('astro:page-load', applyTheme)
</script>

<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" href="/favicon.ico" />
    <title>{title}</title>
    <ClientRouter />
  </head>
  <body>
    <slot />
    <div transition:name="dock" transition:persist>
      <Dock siteName={String(Env.SITE_NAME)} client:only="react" />
    </div>
  </body>
</html>

<style is:global>
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation-duration: 0.6s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Header fade animations */
  @keyframes header-fade-out {
    from {
      opacity: 1;
      transform: translateY(0);
    }
    to {
      opacity: 0;
      transform: translateY(-10px);
    }
  }

  @keyframes header-fade-in {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Content slide animations - more subtle */
  @keyframes content-slide-out {
    from {
      transform: translateY(0);
      opacity: 1;
    }
    to {
      transform: translateY(-20px);
      opacity: 0;
    }
  }

  @keyframes content-slide-in {
    from {
      transform: translateY(20px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Fade animations for smoother transitions */
  @keyframes fade-out {
    from {
      opacity: 1;
    }
    to {
      opacity: 0;
    }
  }

  @keyframes fade-in {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Header transition styles */
  ::view-transition-old(page-header),
  ::view-transition-new(page-header) {
    animation-duration: 0.4s;
    animation-timing-function: ease-in-out;
    animation-fill-mode: both;
  }

  ::view-transition-old(page-header) {
    animation-name: header-fade-out;
  }

  ::view-transition-new(page-header) {
    animation-name: header-fade-in;
  }

  /* Main content transition styles */
  ::view-transition-old(main-content),
  ::view-transition-new(main-content) {
    animation-duration: 0.4s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    animation-fill-mode: both;
  }

  ::view-transition-old(main-content) {
    animation-name: content-slide-out;
  }

  ::view-transition-new(main-content) {
    animation-name: content-slide-in;
  }

  /* Dock - persist without animation */
  ::view-transition-old(dock),
  ::view-transition-new(dock) {
    animation: none !important;
  }

  /* Root transition - subtle fade */
  ::view-transition-old(root),
  ::view-transition-new(root) {
    animation-duration: 0.3s;
    animation-timing-function: ease-in-out;
  }

  ::view-transition-old(root) {
    animation-name: fade-out;
  }

  ::view-transition-new(root) {
    animation-name: fade-in;
  }

  /* Inbox to email detail transitions */
  ::view-transition-old(inbox-container),
  ::view-transition-new(email-detail) {
    animation-duration: 0.5s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  }

  ::view-transition-old(inbox-container) {
    animation-name: content-slide-out;
  }

  ::view-transition-new(email-detail) {
    animation-name: content-slide-in;
  }

  /* Email detail to inbox transitions */
  ::view-transition-old(email-detail),
  ::view-transition-new(inbox-container) {
    animation-duration: 0.5s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  }

  ::view-transition-old(email-detail) {
    animation-name: content-slide-out;
  }

  ::view-transition-new(inbox-container) {
    animation-name: content-slide-in;
  }

  /* Documentation page transitions */
  ::view-transition-old(docs-content),
  ::view-transition-new(docs-content) {
    animation-duration: 0.4s;
    animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    animation-fill-mode: both;
  }

  ::view-transition-old(docs-content) {
    animation-name: content-slide-out;
  }

  ::view-transition-new(docs-content) {
    animation-name: content-slide-in;
  }

  /* Documentation TOC - keep in place with subtle fade */
  ::view-transition-old(docs-toc),
  ::view-transition-new(docs-toc) {
    animation-duration: 0.3s;
    animation-timing-function: ease-in-out;
  }

  ::view-transition-old(docs-toc) {
    animation-name: fade-out;
  }

  ::view-transition-new(docs-toc) {
    animation-name: fade-in;
  }

  /* Scale animation for interactive elements */
  @keyframes scale-in {
    from {
      transform: scale(0.95);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }

  @keyframes scale-out {
    from {
      transform: scale(1);
      opacity: 1;
    }
    to {
      transform: scale(0.95);
      opacity: 0;
    }
  }

  /* Slide from right for modals/dialogs */
  @keyframes slide-in-right {
    from {
      transform: translateX(20px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slide-out-right {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(20px);
      opacity: 0;
    }
  }

  /* Slide from left */
  @keyframes slide-in-left {
    from {
      transform: translateX(-20px);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  @keyframes slide-out-left {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(-20px);
      opacity: 0;
    }
  }

  /* Respect user's motion preferences */
  @media (prefers-reduced-motion: reduce) {
    ::view-transition-old(*),
    ::view-transition-new(*) {
      animation-duration: 0.2s !important;
      animation-name: fade-out !important;
    }

    ::view-transition-new(*) {
      animation-name: fade-in !important;
    }
  }
</style>
