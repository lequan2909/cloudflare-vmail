---
import PageHeader from '@/components/PageHeader.astro'
import Layout from '@/layouts/Layout.astro'

interface Props {
  title: string
  description: string
  pageTitle: string
  lastUpdated?: string
  headings?: { depth: number; slug: string; text: string }[]
}

const { title, description, pageTitle, lastUpdated, headings = [] } = Astro.props

// Filter headings to only include h2 and h3
const tocHeadings = headings.filter(h => h.depth === 2 || h.depth === 3)
---

<Layout title={title} description={description}>
  <PageHeader title={pageTitle} description={description} showBackButton={true} />

  <main class="max-w-7xl mx-auto px-6 py-6">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
      <!-- Table of Contents - Sidebar -->
      {tocHeadings.length > 0 && (
        <aside class="lg:col-span-3 hidden lg:block animate-in slide-in-from-left duration-500">
          <div class="sticky top-6">
            <nav class="bg-card border border-border rounded-lg p-6">
              <h3 class="text-sm font-semibold text-foreground uppercase tracking-wide mb-4">
                ðŸ“‘ On This Page
              </h3>
              <div class="space-y-1" data-toc-container>
                {tocHeadings.map((heading) => (
                  <a
                    href={`#${heading.slug}`}
                    class:list={[
                      'block py-1.5 text-sm transition-colors duration-200 hover:text-foreground',
                      heading.depth === 3 ? 'pl-4 text-muted-foreground' : 'font-medium text-muted-foreground',
                    ]}
                    data-toc-link
                    data-heading-id={heading.slug}
                  >
                    <span class="line-clamp-2">{heading.text}</span>
                  </a>
                ))}
              </div>
            </nav>
          </div>
        </aside>
      )}

      <!-- Main Content -->
      <article
        class:list={[
          tocHeadings.length > 0 ? 'lg:col-span-9' : 'lg:col-span-12',
          'animate-in slide-in-from-right duration-700'
        ]}
      >
        <div class="bg-card border border-border rounded-lg shadow-sm overflow-hidden">
          <div class="p-8 lg:p-12">
            <div class="prose prose-lg max-w-none dark:prose-invert">
              <slot />
            </div>

            {lastUpdated && (
              <div class="mt-12 pt-6 border-t border-border">
                <p class="text-sm text-muted-foreground flex items-center gap-2">
                  <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"
                    />
                  </svg>
                  Last updated: {lastUpdated}
                </p>
              </div>
            )}
          </div>
        </div>
      </article>
    </div>
  </main>
</Layout>

<script>
  // Highlight active section in TOC based on scroll position
  function initTOCHighlight() {
    const tocLinks = document.querySelectorAll('[data-toc-link]')
    if (tocLinks.length === 0) return

    const headingElements = Array.from(tocLinks).map(link => {
      const id = link.getAttribute('data-heading-id')
      return id ? document.getElementById(id) : null
    }).filter(Boolean) as HTMLElement[]

    if (headingElements.length === 0) return

    // Set up intersection observer for heading visibility
    const observerOptions = {
      rootMargin: '-100px 0px -66%',
      threshold: 0,
    }

    let activeHeading: string | null = null

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const id = entry.target.id
        const link = document.querySelector(`[data-heading-id="${id}"]`)

        if (entry.isIntersecting) {
          // Remove active state from all links
          tocLinks.forEach(l => {
            l.classList.remove('text-foreground', '!font-semibold')
            l.classList.add('text-muted-foreground')
          })

          // Add active state to current link
          if (link) {
            link.classList.remove('text-muted-foreground')
            link.classList.add('text-foreground', '!font-semibold')
            activeHeading = id
          }
        }
      })
    }, observerOptions)

    // Observe all heading elements
    headingElements.forEach(heading => observer.observe(heading))
  }

  // Smooth scroll for TOC links
  function setupSmoothScroll() {
    const tocLinks = document.querySelectorAll('[data-toc-link]')

    tocLinks.forEach((link) => {
      link.addEventListener('click', (e) => {
        e.preventDefault()
        const id = link.getAttribute('data-heading-id')

        if (id) {
          const target = document.getElementById(id)
          if (target) {
            // Scroll with offset for fixed header
            const yOffset = -100
            const y = target.getBoundingClientRect().top + window.pageYOffset + yOffset
            window.scrollTo({ top: y, behavior: 'smooth' })

            // Update URL
            history.pushState(null, '', `#${id}`)
          }
        }
      })
    })
  }

  // Initialize on page load
  function initDocs() {
    initTOCHighlight()
    setupSmoothScroll()
  }

  // Run on initial load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initDocs)
  } else {
    initDocs()
  }
</script>

<style>
  /* Smooth scroll behavior */
  html {
    scroll-behavior: smooth;
  }

  /* Custom scrollbar for TOC */
  [data-toc-container] {
    max-height: calc(100vh - 200px);
    overflow-y: auto;
    scrollbar-width: thin;
    scrollbar-color: hsl(var(--border)) transparent;
  }

  [data-toc-container]::-webkit-scrollbar {
    width: 4px;
  }

  [data-toc-container]::-webkit-scrollbar-track {
    background: transparent;
  }

  [data-toc-container]::-webkit-scrollbar-thumb {
    background: hsl(var(--border));
    border-radius: 2px;
  }

  [data-toc-container]::-webkit-scrollbar-thumb:hover {
    background: hsl(var(--muted-foreground));
  }

  /* Active indicator for TOC links */
  [data-toc-link] {
    position: relative;
  }

  [data-toc-link]::before {
    content: '';
    position: absolute;
    left: -20px;
    top: 50%;
    transform: translateY(-50%);
    width: 3px;
    height: 0;
    background: hsl(var(--primary));
    transition: height 0.2s ease;
    border-radius: 2px;
  }

  [data-toc-link].text-foreground::before {
    height: 70%;
  }

  /* Hover effect */
  [data-toc-link]:hover {
    padding-left: 4px;
    transition: padding-left 0.2s ease;
  }
</style>
