---
import type { MailboxSession } from '@/actions'
import { encodeJWTSecret } from '@/lib/utils'
import * as jose from 'jose'
import CopyButton from './CopyButton'
import DeleteEveryThingButton from './DeleteEveryThingButton'
import ExitButton from './ExitButton'
import SenderButton from './SendEmailButton'

interface Props {
  hasMails?: boolean
}

const { hasMails } = Astro.props

const savedMailbox = Astro.cookies.get('mailbox')?.json() as MailboxSession

// eslint-disable-next-line antfu/no-top-level-await
const verified = await jose
  .jwtVerify(savedMailbox.token, encodeJWTSecret(String(Astro.locals.runtime.env.JWT_SECRET)))
  .then(() => true)
  .catch(() => false)
---

<div class='space-y-4'>
  {
    verified && (
      <div class='space-y-3'>
        <label class='text-sm font-medium text-card-foreground'>Your Email Address</label>
        <div class='flex items-center gap-2 p-3 bg-muted rounded-md border border-border'>
          <span class='flex-1 truncate text-sm font-mono text-muted-foreground'>
            {savedMailbox.mailbox}
          </span>
          <CopyButton
            client:load
            content={savedMailbox.mailbox}
            className='p-1.5 rounded-md hover:bg-background transition-colors'
          />
        </div>
      </div>
    )
  }

  {
    !verified && (
      <div class='rounded-md border border-destructive/50 bg-destructive/10 p-4'>
        <div class='text-sm text-destructive'>
          <strong>Verification Failed:</strong> Your mailbox token may be expired or invalid.
        </div>
      </div>
    )
  }

  <div class='space-y-2'>
    <ExitButton client:only='react' />
    <div class='grid grid-cols-2 gap-2'>
      <SenderButton client:only='react' />
      <DeleteEveryThingButton isDisabled={!hasMails} client:only='react' />
    </div>
  </div>
</div>
