---
import Layout from '@/layouts/Layout.astro'
import { Icon } from 'astro-icon/components'
import * as DAO from 'database/dao'
import { getCloudflareD1 } from 'database/db'
import { format } from 'date-fns'
import { UserCircleIcon } from 'lucide-react'

const { id } = Astro.params as { id: string }

const db = getCloudflareD1(Astro.locals.runtime.env.DB)

let data
let error

try {
  data = await DAO.getEmail(db, id)
  if (!data) {
    error = 'Email not found'
  }
}
 catch (e) {
  error = e instanceof Error ? e.message : 'Failed to fetch email'
}

const Env = Astro.locals.runtime.env
---

<Layout
  title={`${data?.id || 'ERROR'} - ${Env.SITE_NAME}`}
  description={Env.SITE_DESCRIPTION}
>
  <div class="mt-24 mx-6 md:mx-10 flex flex-1 flex-col p-2 gap-10">
    <a
      href="/"
      class="flex text-primary w-fit font-semibold items-center border p-2 rounded-md gap-2 border-border"
    >
      <Icon name="mdi:arrow-left" />
      Back Home
    </a>

    {
      error
? (
        <div class="flex flex-col items-center justify-center text-center p-8">
          <div class="text-red-500 font-semibold mb-2">Error</div>
          <div class="text-sm text-muted-foreground">{error}</div>
        </div>
      )
: (
        data && (
          <main>
            <div class="flex items-start text-primary">
              <div class="flex items-start gap-4 text-sm">
                <UserCircleIcon />
                <div class="grid gap-1">
                  <div class="font-semibold">{data.from.name}</div>
                  <div class="line-clamp-1 text-xs">{data.subject}</div>
                  <div class="line-clamp-1 text-xs">
                    <span class="font-medium">Reply-To:</span> {data.from.address}
                  </div>
                  <div class="line-clamp-1 text-xs">Email ID: {data.id}</div>
                </div>
              </div>
              {data.date && (
                <div class="ml-auto text-xs text-muted-foreground">
                  {format(new Date(data.date), 'PPpp')}
                </div>
              )}
            </div>
            <div class="flex-1 flex text-sm border-border backdrop-blur-xl rounded-md p-3 min-h-0 overflow-y-auto">
              <article class="prose" set:html={data.html || data.text || ''} />
            </div>
          </main>
        )
      )
    }
  </div>
</Layout>
